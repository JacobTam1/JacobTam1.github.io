<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Org Chart</title>
  <style>
    /* ─── Global layout ───────────────────────────────── */
    html, body { margin:0; height:100%; overflow:hidden; background:#fafafa; }
    body        { display:flex; font-family:sans-serif; }

    /* ─── Sidebar ─────────────────────────────────────── */
    #sidebar{
      width:300px;                         /* ← new width */
      background:#fff;
      border-right:1px solid #ccc;
      padding:12px;
      box-sizing:border-box;
      position:relative;
      z-index:1000;                        /* stay above SVG */
      display:flex; flex-direction:column;
    }
    #sidebar h3{
      margin:0 0 10px;
      font-size:28px;                      /* bigger heading */
    }
    #deptList{
      list-style:none; margin:0; padding:0;
      flex:1; overflow-y:auto;
    }
    #deptList li{
      padding:10px 14px;
      margin-bottom:4px;
      cursor:pointer;
      border-radius:4px;
      font-size:18px; line-height:1.3;
    }
    #deptList li.selected{ background:#950038; color:#fff; }

    /* company word-mark at bottom */
    #sidebarLogo{
      width:50%; object-fit:contain;
      margin-top:auto; padding-top:12px;
    }

    /* ─── SVG / chart ────────────────────────────────── */
    svg          { flex:1; overflow:visible; }

    .link        { fill:none; stroke:#999; stroke-width:1.5px; }
    .link.highlight{ stroke:#950038; stroke-width:2.5px; }

    .node rect   { fill:#fff; stroke:#ccc; stroke-width:1.5px; rx:5px; ry:5px; }
    .node.selected rect{ stroke:#950038; stroke-width:2.5px; }

    .node-name   { font:14px "PPNeueMontreal-Medium v2.4",sans-serif;
                   font-weight:600; fill:#950038; text-anchor:middle; }
    .node-title  { font:12px sans-serif; fill:#666; text-align:center; }

    .node-count  { font:10px sans-serif; fill:#666; }
  </style>
</head>
<body>
  <!-- ── sidebar ────────────────────────────────────── -->
  <div id="sidebar">
    <h3>Departments</h3>
    <ul id="deptList"></ul>
    <img id="sidebarLogo"
         src="Forum_Wordmark_vBURGUNDY-01.png"
         alt="Forum logo">
  </div>

  <!-- ── SVG container ──────────────────────────────── -->
  <svg id="orgChart"></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  /* ─── Layout constants ───────────────────────────── */
  const nodeW = 180, nodeH = 110, img = 40;
  const vGap  = 100, hGap  = 0;

  /* ─── SVG & groups ──────────────────────────────── */
  const svg   = d3.select("#orgChart");
  const gMain = svg.append("g").attr("class","chart");
  const gLinks= gMain.append("g").attr("class","links");
  const gNodes= gMain.append("g").attr("class","nodes");

  const zoom = d3.zoom()
      .scaleExtent([.5,2])
      .on("zoom", e => gMain.attr("transform", e.transform));
  svg.call(zoom);

  /* ─── Globals ───────────────────────────────────── */
  let rawData, curRoot, selectedNode = null;

  const tree = d3.tree()
      .nodeSize([nodeW + hGap, nodeH + vGap])
      .separation((a,b)=>(a.parent===b.parent?1.2:1.8));

  /* collapse children below (level) */
  function collapseToLevel(node, level, depth=0){
    if(depth>=level && node.children){
      node._children = node.children;
      node._children.forEach(c=>collapseToLevel(c,level,depth+1));
      node.children = null;
    }else if(node.children){
      node.children.forEach(c=>collapseToLevel(c,level,depth+1));
    }
  }

  /* build hierarchy, optional dept filter */
  function buildHierarchy(data, dept){
    const rows = (dept && dept!=="All") ? data.filter(d=>d.Department===dept) : data;
    const byId = new Map();
    rows.forEach(r=>byId.set(r.PersonID,{...r,children:[]}));
    const roots=[];
    rows.forEach(r=>{
      const n=byId.get(r.PersonID);
      if(!r.SupervisorID || !byId.has(r.SupervisorID)) roots.push(n);
      else byId.get(r.SupervisorID).children.push(n);
    });
    if(roots.length===1) return d3.hierarchy(roots[0]);
    return d3.hierarchy({ _dummy:true, children:roots });
  }

  /* deep search incl. collapsed nodes */
  function findNodeDeep(node, pred){
    if(pred(node)) return node;
    for(const grp of [node.children,node._children]){
      if(grp){
        for(const c of grp){
          const f=findNodeDeep(c,pred);
          if(f) return f;
        }
      }
    }
    return null;
  }
  function expandAncestors(n){
    if(n.parent){
      if(n.parent._children){
        n.parent.children = n.parent._children;
        n.parent._children = null;
      }
      expandAncestors(n.parent);
    }
  }

  /* ─── Focus / zoom helper ───────────────────────── */
  function focusOn(node, scale=1.2){
    const cW = svg.node().clientWidth;
    const cH = svg.node().clientHeight;
    const padTop = 40;                       // keep in sync

    const tx = cW/2 - node.x;
    const ty = cH/2 - node.y + padTop;

    svg.transition()
       .duration(600)
       .call(zoom.transform,
             d3.zoomIdentity.translate(tx,ty).scale(scale));
  }

  /* ─── Render / update ───────────────────────────── */
  function render(root){
    curRoot=root;
    tree(root);

    const nodes = root.descendants().filter(d=>!d.data._dummy);
    const links = root.links().filter(l=>!l.source.data._dummy && !l.target.data._dummy);

    /* ---- LINKS ---- */
    const linkSel = gLinks.selectAll("path.link")
        .data(links, d=>d.target.data.PersonID);

    linkSel.exit().remove();

    linkSel.enter().append("path").attr("class","link")
      .merge(linkSel)
        .attr("d", d=>`M${d.source.x},${d.source.y}V${d.target.y}H${d.target.x}`)
        .classed("highlight", d=>isHighlighted(d));

    /* ---- NODES ---- */
    const nodeSel = gNodes.selectAll("g.node")
        .data(nodes, d=>d.data.PersonID);
    nodeSel.exit().remove();

    const nodeEnter = nodeSel.enter().append("g")
        .attr("class","node")
        .attr("transform", d=>`translate(${d.x},${d.y})`)
        .on("click", (e,d)=>{
          if(d.children){ d._children=d.children; d.children=null; }
          else if(d._children){ d.children=d._children; d._children=null; }
          selectedNode = d;
          render(root);
          focusOn(d);                         // ← zoom to clicked
        });

    nodeEnter.append("rect")
      .attr("x",-nodeW/2).attr("y",-nodeH/2)
      .attr("width",nodeW).attr("height",nodeH);

    nodeEnter.append("svg:image")
      .attr("x",-img/2).attr("y",-nodeH/2+10)
      .attr("width",img).attr("height",img)
      .attr("href", d=>d.data.Photo||"");

    nodeEnter.append("text")
      .attr("class","node-name")
      .attr("dy",-nodeH/2+10+img+15)
      .text(d=>d.data.Name);

    nodeEnter.append("foreignObject")
      .attr("x",-nodeW/2).attr("y",-nodeH/2+10+img+20)
      .attr("width",nodeW).attr("height",40)
      .append("xhtml:div")
        .attr("class","node-title")
        .style("width",nodeW+"px")
        .style("word-wrap","break-word")
        .style("overflow","hidden")
        .style("text-overflow","ellipsis")
        .style("white-space","nowrap")
        .text(d=>{
          const t=d.data["Job Title"]||"";
          return t.length>50 ? t.slice(0,47)+"…" : t;
        });

    nodeEnter.filter(d=>d.children?.length||d._children?.length)
      .append("text")
      .attr("class","node-count")
      .attr("text-anchor","end")
      .attr("x",nodeW/2-4).attr("y",nodeH/2-4)
      .text(cntTxt);

    const nodeMerge = nodeEnter.merge(nodeSel);
    nodeMerge.attr("transform", d=>`translate(${d.x},${d.y})`)
             .classed("selected", d=>selectedNode && d===selectedNode)
             .select(".node-count").text(cntTxt);

    /* ---- auto-centre (X & Y) ---- */
    const [xMin,xMax] = d3.extent(nodes, d=>d.x);
    const [yMin,yMax] = d3.extent(nodes, d=>d.y);
    const viewW = xMax - xMin + nodeW*2;
    const viewH = yMax - yMin + nodeH*2;

    const cW = svg.node().clientWidth;
    const cH = svg.node().clientHeight;
    const padTop = 40;

    const tx = (cW - viewW)/2 - xMin;
    const ty = (cH - viewH)/2 - yMin + padTop;

    svg.transition()
       .duration(600)
       .call(zoom.transform,
             d3.zoomIdentity.translate(tx,ty));
  }

  function cntTxt(d){
    if(!d.children && !d._children) return "";
    const c = d.children ? d.children.length : d._children.length;
    const sym = d._children ? "▶" : "▼";
    return `${c} ${sym}`;
  }

  function isHighlighted(link){
    if(!selectedNode) return false;
    let cur=selectedNode;
    while(cur.parent){
      if(cur.parent===link.source && cur===link.target) return true;
      cur=cur.parent;
    }
    return false;
  }

  /* ─── Sidebar list ─────────────────────────────── */
  function populateSidebar(data){
    const depts = Array.from(new Set(data.map(d=>d.Department))).sort();
    depts.unshift("All");

    const list = d3.select("#deptList");
    list.selectAll("li").data(depts).enter()
      .append("li").text(d=>d)
      .classed("selected", d=>d==="All")
      .on("click", (ev,dept)=>{
        list.selectAll("li").classed("selected", d=>d===dept);
        selectedNode=null;
        const root = buildHierarchy(rawData,dept);
        const visible = root.data._dummy ? 2 : 1;
        collapseToLevel(root, visible);
        render(root);
      });
  }

  /* ─── Search box & dropdown ────────────────────── */
  const SEARCH_W = 260;
  const searchInput = document.createElement("input");
  Object.assign(searchInput,{
    type:"text", placeholder:"Search…"
  });
  Object.assign(searchInput.style,{
    position:"fixed", top:"12px", right:"20px",
    width: SEARCH_W + "px",
    height: "34px",
    padding:"6px 10px", border:"1px solid #ccc",
    borderRadius:"4px", fontSize:"20px", fontFamily:'"PPNeueMontreal-Medium v2.4",sans-serif',zIndex:1100
  });
  document.body.appendChild(searchInput);

  const dropdown = document.createElement("div");
  Object.assign(dropdown.style,{
    position:"fixed", top:"52px", right:"20px",
    width:(SEARCH_W+(2*6)) +"px",
    maxHeight:"200px", overflowY:"auto",
    background:"#fff", border:"1px solid #ccc",
    borderRadius:"4px", fontSize:"16px",
    display:"none", zIndex:1100
  });
  document.body.appendChild(dropdown);

  function updateDropdown(matches){
    dropdown.innerHTML="";
    if(!matches.length){ dropdown.style.display="none"; return; }
    matches.forEach(m=>{
      const div=document.createElement("div");
      div.textContent=m.data.Name;
      Object.assign(div.style,{padding:"6px 10px",cursor:"pointer", fontFamily: '"PPNeueMontreal-Medium v2.4",sans-serif',fontSize:"22px"});
      div.addEventListener("mouseover",()=>div.style.background="#f0f0f0");
      div.addEventListener("mouseout", ()=>div.style.background="transparent");
      div.addEventListener("click", ()=>selectPerson(m.data.Name));
      dropdown.appendChild(div);
    });
    dropdown.style.display="block";
  }

  function selectPerson(name){
    dropdown.style.display="none";
    searchInput.value="";
    /* always switch to All to guarantee presence */
    d3.selectAll("#deptList li").classed("selected", d=>d==="All");
    const root = buildHierarchy(rawData,"All");
    collapseToLevel(root,1);

    const target = findNodeDeep(root, n=>n.data.Name===name);
    if(!target){ render(root); return; }
    expandAncestors(target);
    selectedNode = target;
    render(root);
    focusOn(target);
  }

  searchInput.addEventListener("input", e=>{
    const q=e.target.value.trim().toLowerCase();
    if(!q){ dropdown.style.display="none"; return; }
    const rootAll = buildHierarchy(rawData,"All");
    const matches=[];
    rootAll.each(n=>{
      if(n.data && n.data.Name && n.data.Name.toLowerCase().includes(q))
        matches.push(n);
    });
    updateDropdown(matches.slice(0,20));
  });

  /* ─── Data load & kick-off ─────────────────────── */
  d3.csv("general_bamboohr_org_chart.csv").then(data=>{
    data.forEach(d=>{
      d.SupervisorID = (!d.SupervisorID||d.SupervisorID.trim()===""||d.SupervisorID==="NULL")?null:d.SupervisorID;
      if(d.Name) d.Name=d.Name.replace(/\r|\n/g," ").trim();
      if(d["Job Title"]) d["Job Title"]=d["Job Title"].replace(/\r|\n/g," ").trim();
    });
    rawData=data;
    populateSidebar(data);

    const root = buildHierarchy(data,"All");
    collapseToLevel(root,1);                       // CEO + direct reports
    render(root);
  }).catch(console.error);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Org Chart</title>
<style>
/* ——— layout ——— */
html,body{margin:0;height:100%;overflow:hidden;background:#fafafa}
body{display:flex;font-family:sans-serif}

/* ——— sidebar ——— */
#sidebar{width:300px;background:#fff;border-right:1px solid #ccc;
  padding:12px;box-sizing:border-box;display:flex;flex-direction:column;
  position:relative;z-index:1000}
#sidebar h3{margin:0 0 10px;font-size:28px}
#deptList{list-style:none;margin:0;padding:0;flex:1;overflow-y:auto}
#deptList li{padding:10px 14px;margin-bottom:4px;cursor:pointer;border-radius:4px;
  font-size:18px;line-height:1.3}
#deptList li.selected{background:#950038;color:#fff}
#sidebarLogo{width:50%;object-fit:contain;margin-top:auto;padding-top:12px}

/* ——— chart SVG ——— */
svg{flex:1;overflow:visible;cursor:url(open.png) 12 12, grab}
svg.grabbing{cursor:url(closed.png) 12 12, grabbing}

/* links & nodes */
.link{fill:none;stroke:#999;stroke-width:1.5px}
.link.highlight{stroke:#950038;stroke-width:2.5px}
.node rect{fill:#fff;stroke:#ccc;stroke-width:1.5px;rx:5px;ry:5px}
.node.selected rect{stroke:#950038;stroke-width:2.5px}
.node-name{font:14px "PPNeueMontreal-Medium v2.4",sans-serif;font-weight:600;
  fill:#950038;text-anchor:middle}
.node-title{font:12px sans-serif;fill:#666;text-align:center}
.node-count{font:16px "PPNeueMontreal-Light v2.4",sans-serif;fill:#666;
  cursor:pointer}

/* zoom / fit button */
#zoomBtn{position:fixed;right:24px;bottom:24px;padding:10px 14px;
  background:#950038;color:#fff;border:none;border-radius:4px;cursor:pointer;
  font:14px sans-serif;z-index:1100}
</style>
</head>
<body>

<!-- ——— sidebar ——— -->
<div id="sidebar">
  <h3>Departments</h3>
  <ul id="deptList"></ul>
  <img id="sidebarLogo" src="Forum_Wordmark_vBURGUNDY-01.png" alt="Forum logo">
</div>

<!-- ——— SVG ——— -->
<svg id="orgChart"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
/* ——— constants ——— */
const SIDEBAR_W = 300;
const nodeW=180,nodeH=110,img=40,vGap=100,hGap=0,SEARCH_W=260;

/* ——— SVG & zoom ——— */
const svg=d3.select("#orgChart");
const gMain=svg.append("g"),gLinks=gMain.append("g"),gNodes=gMain.append("g");

const zoom=d3.zoom()
 .scaleExtent([.5,2])
 .on("start",()=>svg.classed("grabbing",true))
 .on("zoom",e=>gMain.attr("transform",e.transform))
 .on("end",()=>svg.classed("grabbing",false));
svg.call(zoom);
["mouseup","touchend"].forEach(ev=>addEventListener(ev,()=>svg.classed("grabbing",false)));

/* ——— globals ——— */
let rawData,curRoot,selectedNode=null,fitMode=false;
const tree=d3.tree().nodeSize([nodeW+hGap,nodeH+vGap])
  .separation((a,b)=>(a.parent===b.parent?1.2:1.8));

/* ——— helpers ——— */
function collapseToLevel(n,l,d=0){
  if(d>=l&&n.children){n._children=n.children;n._children.forEach(c=>collapseToLevel(c,l,d+1));n.children=null;}
  else n.children?.forEach(c=>collapseToLevel(c,l,d+1));
}
function buildHierarchy(data,dept){
  const rows=(dept&&dept!=="All")?data.filter(d=>d.Department===dept):data;
  const byId=new Map();rows.forEach(r=>byId.set(r.PersonID,{...r,children:[]}));
  const roots=[];
  rows.forEach(r=>{
    const n=byId.get(r.PersonID);
    if(!r.SupervisorID||!byId.has(r.SupervisorID)) roots.push(n);
    else byId.get(r.SupervisorID).children.push(n);
  });
  return roots.length===1?d3.hierarchy(roots[0]):d3.hierarchy({_dummy:true,children:roots});
}
const findNodeDeep=(n,p)=>p(n)?n:
  (n.children&&n.children.map(c=>findNodeDeep(c,p)).find(Boolean))||
  (n._children&&n._children.map(c=>findNodeDeep(c,p)).find(Boolean))||null;
const expandAncestors=n=>{if(n.parent){if(n.parent._children){n.parent.children=n.parent._children;n.parent._children=null;}expandAncestors(n.parent);}};

const cntTxt=d=>!d.children&&!d._children?"":`${d.children?d.children.length:d._children.length} ${d._children?"▶":"▼"}`;
const isHighlighted=l=>{if(!selectedNode)return false;let c=selectedNode;while(c.parent){if(c.parent===l.source&&c===l.target)return true;c=c.parent;}return false;};

/* ——— focus / restore ——— */
function focusOn(n,scale=1.2){
  fitMode=false;zoomBtn.textContent="Fit";
  const cW=svg.node().clientWidth,cH=svg.node().clientHeight,pad=40;
  svg.transition().duration(700)
     .call(zoom.transform,d3.zoomIdentity.translate(cW/2-n.x,cH/2-n.y+pad).scale(scale));
}

/* ——— render ——— */
function render(root){
  curRoot=root;tree(root);
  const nodes=root.descendants().filter(d=>!d.data._dummy),
        links=root.links().filter(l=>!l.source.data._dummy&&!l.target.data._dummy);

  /* links */
  const lSel=gLinks.selectAll("path").data(links,d=>d.target.data.PersonID);
  lSel.exit().remove();
  lSel.enter().append("path").attr("class","link")
      .merge(lSel)
        .attr("d",d=>`M${d.source.x},${d.source.y}V${d.target.y}H${d.target.x}`)
        .classed("highlight",isHighlighted);

  /* nodes */
  const nSel=gNodes.selectAll("g.node").data(nodes,d=>d.data.PersonID);
  nSel.exit().remove();
  const nEnter=nSel.enter().append("g").attr("class","node")
      .attr("transform",d=>`translate(${d.x},${d.y})`)
      .on("mousedown",()=>svg.classed("grabbing",true))
      .on("click",(ev,d)=>{
        if(d.children){d._children=d.children;d.children=null;}
        else if(d._children){d.children=d._children;d._children=null;}
        selectedNode=d;render(root);focusOn(d);
      });

  nEnter.append("rect").attr("x",-nodeW/2).attr("y",-nodeH/2)
        .attr("width",nodeW).attr("height",nodeH);

  nEnter.append("svg:image").attr("x",-img/2).attr("y",-nodeH/2+10)
        .attr("width",img).attr("height",img).attr("href",d=>d.data.Photo||"");

  nEnter.append("text").attr("class","node-name")
        .attr("dy",-nodeH/2+10+img+15).text(d=>d.data.Name);

  nEnter.append("foreignObject").attr("x",-nodeW/2).attr("y",-nodeH/2+10+img+20)
        .attr("width",nodeW).attr("height",40)
      .append("xhtml:div").attr("class","node-title")
        .style("width",nodeW+"px").style("overflow","hidden")
        .style("text-overflow","ellipsis").style("white-space","nowrap")
        .text(d=>{const t=d.data["Job Title"]||"";return t.length>50?t.slice(0,47)+"…":t;});

  nEnter.filter(d=>d.children?.length||d._children?.length)
        .append("text").attr("class","node-count")
        .attr("text-anchor","end").attr("x",nodeW/2-4).attr("y",nodeH/2-4)
        .text(cntTxt);

  const nMerge=nEnter.merge(nSel);
  nMerge.attr("transform",d=>`translate(${d.x},${d.y})`)
        .classed("selected",d=>selectedNode&&d===selectedNode)
        .select(".node-count").text(cntTxt);

  /* auto-centre (only when NOT in fit-all mode) */
  if(!fitMode){
    const [xMin,xMax]=d3.extent(nodes,d=>d.x),
          [yMin,yMax]=d3.extent(nodes,d=>d.y),
          cW=svg.node().clientWidth,cH=svg.node().clientHeight,pad=40;
    svg.transition().duration(600)
       .call(zoom.transform,
         d3.zoomIdentity.translate((cW-(xMax-xMin+nodeW*2))/2 - xMin,
                                   (cH-(yMax-yMin+nodeH*2))/2 - yMin + pad));
  }
}

/* ——— sidebar ——— */
function populateSidebar(data){
  const depts=['All',...Array.from(new Set(data.map(d=>d.Department))).sort()];
  d3.select("#deptList").selectAll("li").data(depts).enter()
    .append("li").text(d=>d).classed("selected",d=>d==='All')
    .on("click",(ev,dept)=>{
      d3.selectAll("#deptList li").classed("selected",d=>d===dept);
      selectedNode=null;fitMode=false;zoomBtn.textContent="Fit";
      const r=buildHierarchy(rawData,dept);collapseToLevel(r,r.data._dummy?2:1);render(r);
    });
}

/* ——— search UI ——— */
const inp=Object.assign(document.createElement("input"),{type:"text",placeholder:"Search…"});
Object.assign(inp.style,{position:"fixed",top:"12px",right:"20px",
  width:SEARCH_W+"px",height:"36px",padding:"6px 10px",border:"1px solid #ccc",
  borderRadius:"4px",fontSize:"20px",fontFamily:'"PPNeueMontreal-Medium v2.4",sans-serif',
  zIndex:1100});
document.body.appendChild(inp);

const dd=document.createElement("div");
Object.assign(dd.style,{position:"fixed",top:"52px",right:"20px",
  width:SEARCH_W+"px",maxHeight:"240px",overflowY:"auto",background:"#fff",
  border:"1px solid #ccc",borderRadius:"4px",display:"none",zIndex:1100});
document.body.appendChild(dd);

function updateDD(arr){
  dd.innerHTML="";if(!arr.length){dd.style.display="none";return;}
  arr.forEach(n=>{
    const el=document.createElement("div");el.textContent=n.data.Name;
    Object.assign(el.style,{padding:"6px 10px",cursor:"pointer",
      fontFamily:'"PPNeueMontreal-Medium v2.4",sans-serif',fontSize:"18px"});
    el.onmouseover=()=>el.style.background="#f0f0f0";
    el.onmouseout =()=>el.style.background="transparent";
    el.onclick    =()=>selectPerson(n.data.Name);
    dd.appendChild(el);
  });dd.style.display="block";
}
function selectPerson(name){
  dd.style.display="none";inp.value="";
  d3.selectAll("#deptList li").classed("selected",d=>d==="All");
  const r=buildHierarchy(rawData,"All");collapseToLevel(r,1);
  const t=findNodeDeep(r,n=>n.data.Name===name);if(!t){render(r);return;}
  expandAncestors(t);selectedNode=t;render(r);focusOn(t);
}
inp.oninput=e=>{
  const q=e.target.value.trim().toLowerCase();if(!q){dd.style.display="none";return;}
  const r=buildHierarchy(rawData,"All"),m=[];r.each(n=>{
    if(n.data?.Name?.toLowerCase().includes(q))m.push(n);
  });updateDD(m.slice(0,25));
};

/* ——— zoom-to-fit button ——— */
const zoomBtn=document.createElement("button");
zoomBtn.id="zoomBtn";zoomBtn.textContent="Fit";
zoomBtn.onclick=()=>{
  if(!curRoot)return;
  fitMode=!fitMode;
  if(fitMode){  // fit all
    const nodes=curRoot.descendants().filter(d=>!d.data._dummy),
          [xMin,xMax]=d3.extent(nodes,d=>d.x),
          [yMin,yMax]=d3.extent(nodes,d=>d.y),
          cW=svg.node().clientWidth,cH=svg.node().clientHeight,pad=40;
    const dw=xMax-xMin+nodeW*2,dh=yMax-yMin+nodeH*2,
          scale=Math.min((cW)/dw,(cH-pad)/dh);
    svg.transition().duration(700)
       .call(zoom.transform,
             d3.zoomIdentity
               .translate((cW-dw*scale)/2 - xMin*scale,
                          (cH-dh*scale)/2 - yMin*scale + pad/2)
               .scale(scale));
    zoomBtn.textContent="Restore";
  }else{
    selectedNode?focusOn(selectedNode):render(curRoot);
    zoomBtn.textContent="Fit";
  }
};
document.body.appendChild(zoomBtn);

/* ——— load data —— */
d3.csv("general_bamboohr_org_chart.csv").then(data=>{
  data.forEach(d=>{
    d.SupervisorID=!d.SupervisorID||d.SupervisorID.trim()==="NULL"?"":d.SupervisorID;
    if(d.Name)d.Name=d.Name.replace(/\r|\n/g," ").trim();
    if(d["Job Title"])d["Job Title"]=d["Job Title"].replace(/\r|\n/g," ").trim();
  });
  rawData=data;populateSidebar(data);
  const root=buildHierarchy(data,"All");collapseToLevel(root,1);render(root);
}).catch(console.error);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Org Chart</title>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #fafafa; }

    /* ─── link lines ─────────────────────────────────────────── */
    .link{ fill:none; stroke:#999; stroke-width:1.5px; }
    .link.highlight{ stroke:#950038; stroke-width:2.5px; }

    /* ─── node card ──────────────────────────────────────────── */
    .node rect{ fill:#fff; stroke:#ccc; stroke-width:1.5px; rx:5px; ry:5px; }
    .node.selected rect{ stroke:#950038; stroke-width:2.5px; }

    .node-name{ font:14px "PPNeueMontreal-Medium v2.4"; font-weight:600; fill:#950038; text-anchor:middle; }
    .node-title{ font:12px sans-serif; fill:#666; text-align:center; dominant-baseline:hanging; width:180px; }
    .node-count{ font:10px sans-serif;  fill:#666; }

    svg{ width:100%; height:100%; overflow:visible; }
  </style>
</head>
<body>
  <svg id="orgChart"></svg>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  /* ─── layout constants ─────────────────────────────────────── */
  const nodeWidth = 180;
  const nodeHeight = 110;
  const imgSize = 40;
  const verticalSpacing   = 100;
  const horizontalSpacing =   0;

  /* ─── SVG scaffold & zoom ──────────────────────────────────── */
  const svg     = d3.select("#orgChart");
  const gMain   = svg.append("g").attr("class","chart");
  const gLinks  = gMain.append("g").attr("class","links");
  const gNodes  = gMain.append("g").attr("class","nodes");

  const zoomBehaviour = d3.zoom()
      .scaleExtent([0.5,2])
      .on("zoom", ev => gMain.attr("transform", ev.transform));
  svg.call(zoomBehaviour);

  /* ─── load CSV and render ──────────────────────────────────── */
  d3.csv("general_bamboohr_org_chart.csv").then(data => {

    /* clean rows */
    data.forEach(d=>{
      d.SupervisorID = (!d.SupervisorID || d.SupervisorID.trim()==="" || d.SupervisorID==="NULL") ? null : d.SupervisorID;
      if(d.Name) d.Name = d.Name.replace(/[\r\n]+/g," ").trim();
      if(d["Job Title"]) d["Job Title"] = d["Job Title"].replace(/[\r\n]+/g," ").trim();
    });

    /* build hierarchy */
    const root = d3.stratify().id(d=>d.PersonID).parentId(d=>d.SupervisorID)(data);

    /* collapse helper */
    function collapseAll(node){
      if(node.children){
        node.children.forEach(collapseAll);
        node._children = node.children;
        node.children  = null;
      }
    }

    /* show only CEO + direct reports initially */
    if(root.children){
      root.children.forEach(child => collapseAll(child));
    }

    /* tree layout */
    const tree = d3.tree()
        .nodeSize([nodeWidth + horizontalSpacing, nodeHeight + verticalSpacing])
        .separation((a,b)=>(a.parent===b.parent?1.2:1.8));

    let selectedNode = null;
    let centredOnce  = false;

    update(root);

    /* ── click handler ────────────────────────────── */
    function onClick(event, d){
      if(d.children){
        d._children = d.children;
        d.children  = null;
      }else if(d._children){
        d.children  = d._children;
        d._children = null;
        /* ensure only direct children show – collapse deeper levels */
        d.children.forEach(child => collapseAll(child));
      }
      selectedNode = d;
      update(d);
    }

    /* ── update / redraw ───────────────────────────── */
    function update(source){
      tree(root);
      const nodes = root.descendants();
      const links = root.links();

      /* ---- NODES ---- */
      const nodeSel = gNodes.selectAll("g.node").data(nodes, d=>d.id);
      nodeSel.exit().remove();

      const nodeEnter = nodeSel.enter().append("g")
          .attr("class","node")
          .attr("transform", d=>`translate(${d.x},${d.y})`)
          .on("click", onClick);

      nodeEnter.append("rect")
          .attr("x", -nodeWidth/2)
          .attr("y", -nodeHeight/2)
          .attr("width", nodeWidth)
          .attr("height", nodeHeight);

      nodeEnter.append("svg:image")
          .attr("x", -imgSize/2)
          .attr("y", -nodeHeight/2 + 10)
          .attr("width", imgSize)
          .attr("height", imgSize)
          .attr("href", d=> d.data.Photo || "");

      nodeEnter.append("text")
          .attr("class","node-name")
          .attr("dy", -nodeHeight/2 + 10 + imgSize + 15)
          .text(d=>d.data.Name);

      nodeEnter.append("foreignObject")
          .attr("x", -nodeWidth/2)
          .attr("y", -nodeHeight/2 + 10 + imgSize + 20)
          .attr("width", nodeWidth)
          .attr("height", 40)
        .append("xhtml:div")
          .attr("class","node-title")
          .style("width", nodeWidth + "px")
          .style("word-wrap","break-word")
          .style("overflow","hidden")
          .style("text-overflow","ellipsis")
          .style("white-space","nowrap")
          .text(d=>{
            const t = d.data["Job Title"] || "";
            return t.length>50 ? t.slice(0,47)+"…" : t;
          });

      nodeEnter.filter(d=> (d.children?.length)||(d._children?.length))
        .append("text")
          .attr("class","node-count")
          .attr("text-anchor","end")
          .attr("x", nodeWidth/2 - 4)
          .attr("y", nodeHeight/2 - 4)
          .text(d=>{
            const cnt = d.children ? d.children.length : d._children ? d._children.length : 0;
            const sym = d._children ? "▶" : "▼";
            return cnt ? (cnt + " " + sym) : "";
          });

      const nodeMerge = nodeEnter.merge(nodeSel);
      nodeMerge.attr("transform", d=>`translate(${d.x},${d.y})`)
               .classed("selected", d=> selectedNode && d===selectedNode);

      nodeMerge.select(".node-count").text(d=>{
        if(!d.children && !d._children) return "";
        const cnt = d.children ? d.children.length : d._children.length;
        const sym = d._children ? "▶" : "▼";
        return cnt + " " + sym;
      });

      /* ---- LINKS ---- */
      const linkSel = gLinks.selectAll("path.link").data(links, d=>d.target.id);
      linkSel.exit().remove();

      const linkEnter = linkSel.enter().append("path")
          .attr("class","link")
          .attr("d", d=>`M${d.source.x},${d.source.y}V${d.target.y}H${d.target.x}`);

      linkEnter.merge(linkSel)
          .attr("d", d=>`M${d.source.x},${d.source.y}V${d.target.y}H${d.target.x}`)
          .attr("class", d=>{
            if(!selectedNode) return "link";
            let cur = selectedNode;
            while(cur.parent){
              if(cur.parent.id===d.source.id && cur.id===d.target.id){
                return "link highlight";
              }
              cur = cur.parent;
            }
            return "link";
          });

      /* ---- initial centring ---- */
      if(!centredOnce){
        const svgW = svg.node().clientWidth;
        const svgH = svg.node().clientHeight;
        const xExtent = d3.extent(nodes, d=>d.x);
        const yExtent = d3.extent(nodes, d=>d.y);
        const chartW = xExtent[1] - xExtent[0];
        const chartH = yExtent[1] - yExtent[0];
        const offsetX = (svgW - chartW)/2 - xExtent[0];
        const offsetY = 200;
        svg.call(zoomBehaviour.transform, d3.zoomIdentity.translate(offsetX, offsetY));
        centredOnce = true;
      }
    }
  }).catch(err=>console.error("Error loading CSV", err));
  </script>
</body>
</html>
